# Autosave settings

We try to enclose most possible autosave configuration within `autosave.iocsh`. 

## Preparation of DB

Each record in database file that needs to have values saved by `autosave` must have the one of following `info` tags. Such as
```
 info(autosaveFields, "PREC SCAN DESC OUT")
 info(autosaveFields_pass0, "VAL")
 info(autosaveFields_pass1, "VAL")
```

Each info tag should be matched with what one would like to use such as


* `autosaveFields` : before and after record initialization
  - `settings.sav` : in `$(AS_TOP)/$(IOCNAME)/save`
  - `settings.req` : in `$(AS_TOP)/$(IOCNAME)/req`
 
* `autosaveFields_pass0` : before record initialization
  - `values_pass0.sav` : in `$(AS_TOP)/$(IOCNAME)/save`
  - `values_pass0.req` : in `$(AS_TOP)/$(IOCNAME)/req`

* `autosaveFields_pass1`: after record initialization (Most autosave values can be restored at Pass 0 and Pass 1 using the `autosaveFields` info tag.)
  - `values_pass1.sav`    : in `$(AS_TOP)/$(IOCNAME)/save`
  - `values_pass1.req`    : in `$(AS_TOP)/$(IOCNAME)/req`

## How to enable it 

The central `autosave.iocsh` file is located in <https://git.als.lbl.gov/alsu/epics/soft-modules/iocsh/-/blob/master/iocshApp/autosave.iocsh>
One can look at many options in the `iocsh` file. The loading the `autosave.iocsh` example is defined in a startup script generated by our IOC template generator. 


```bash
iocshLoad("$(IOCSH_TOP)/autosave.iocsh", "AS_TOP=$(TOP),IOCNAME=$(IOCNAME),DATABASE_TOP=$(DB_TOP),SEQ_PERIOD=60")
```

Note that there are some commands should be executed after `iocInit`. However, if one includes `std` module into, one can use a single `autosave.iocsh` to do these two steps jobs within a single line. So we highly recommend to add `std` module, `doAfterIocInit function` into your application.  


## request (req) files

It is highly recommended to use `info` tag instead of the seperated request files. However, this file would like to help them to use existent request files within `autosave.iocsh` according to existent all EPICS modules' req files, own req files, or both. 


### Example 1

```bash
...
dbLoadRecords("spinnaker.db", "P=$(PREFIX),R=,PORT=$(PORT)")
...
iocshLoad("$(autosave_DIR)/autosave.iocsh", "AS_TOP=$(TOP),IOCNAME=$(IOCNAME)")
#
iocInit()
```


### Example 2

* Define **all** requestfile path before the first `dbLoadRecords`. It is important to open all req files, which are related with all database files. And one has to check where they are. And one has to define them all. 

```
set_requestfile_path("$(CALC_REQ_PATH)", "")
set_requestfile_path("$(BUSY_REQ_PATH)", "")
set_requestfile_path("$(TOP)", "cmds")
```

* Create one own req file in a directory (for example, `cmds`).

```
$ more cmds/auto_settings.req 
file "spinnaker_settings.req",            P=$(P),  R=$(R)
file "NDStdArrays_settings.req",          P=$(P),  R=$(R)
file "commonPlugin_settings.req",         P=$(P)
```

* Add the `create_monitor_set` after `iocInit`
```
create_monitor_set("auto_settings.req", 5, "P=$(PREFIX),R=,IMAGE=$(IMAGE):")
```

```
epicsEnvSet("TOP", "$(TOP)/..")

set_requestfile_path("$(ADSpinnaker_REQ_PATH)", "")
set_requestfile_path("$(ADGenICam_REQ_PATH)", "")
set_requestfile_path("$(ADCore_REQ_PATH)", "")
set_requestfile_path("$(calc_REQ_PATH)", "")
set_requestfile_path("$(busy_REQ_PATH)", "")
set_requestfile_path("$(TOP)", "cmds")

ADSpinnakerConfig("$(PORT)", "$(CAMERA_ID)", 0x1, 0)
dbLoadRecords("spinnaker.db", "P=$(PREFIX),R=,PORT=$(PORT)")
dbLoadRecords("PGR_BlackflyS_50S5C.db", "P=$(PREFIX),R=,PORT=$(PORT)")

NDStdArraysConfigure("$(IMAGE)", 5, 0, "$(PORT)", 0, 0)
dbLoadRecords("NDStdArrays.template", "P=$(PREFIX),R=,PORT=$(IMAGE),ADDR=0,TIMEOUT=1,NDARRAY_PORT=$(PORT),TYPE=Int16,FTVL=SHORT,NELEMENTS=$(NELEMENTS)")
iocshLoad("$(ADCORE)/iocsh/commPlugins.iocsh", "P=$(PREFIX),UNIT=1,PORT=$(IMAGE),QSIZE=$(QSIZE),XSIZE=$(XSIZE),YSIZE=$(YSIZE),NCHANS=$(NCHANS),CBUFFS=$(CBUFFS)")

iocshLoad("$(AUTOSAVE)/iocsh/autosave.iocsh", "AS_TOP=$(TOP),IOCNAME=$(IOCNAME)")

iocInit()

create_monitor_set("auto_settings.req", 5, "P=$(PREFIX),R=,IMAGE=$(IMAGE):")
```

